{% extends 'JLTsite/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{% if product %}Modifier {{ product.name }}{% else %}Nouveau produit{% endif %} - Admin{% endblock %}

{% block extra_css %}
<style>
    /* Admin styles */
    .admin-header {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        padding: 2rem 0;
        color: white;
    }
    
    .admin-nav {
        background: #34495e;
        border-bottom: 3px solid var(--jlt-yellow);
        position: sticky;
        top: 0;
        z-index: 100;
    }
    
    .admin-nav-tabs {
        display: flex;
        gap: 0;
        margin: 0;
        padding: 0;
    }
    
    .admin-nav-tab {
        padding: 1rem 1.5rem;
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .admin-nav-tab:hover {
        background: rgba(255, 255, 255, 0.05);
        color: white;
    }
    
    .admin-nav-tab.active {
        background: rgba(244, 200, 67, 0.1);
        color: var(--jlt-yellow);
        border-bottom: 3px solid var(--jlt-yellow);
    }
    
    .form-container {
        background: var(--jlt-beige);
        padding: 2rem 0;
        min-height: calc(100vh - 200px);
    }
    
    /* Form Card */
    .form-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 3px 15px rgba(0,0,0,0.08);
        overflow: hidden;
    }
    
    .form-header {
        background: linear-gradient(135deg, var(--jlt-beige) 0%, var(--jlt-beige-light) 100%);
        padding: 1.5rem 2rem;
        border-bottom: 3px solid var(--jlt-yellow);
    }
    
    .form-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--jlt-black);
        margin: 0;
    }
    
    .form-body {
        padding: 2rem;
    }
    
    /* Form Sections */
    .form-section {
        margin-bottom: 2rem;
        padding-bottom: 2rem;
        border-bottom: 1px solid var(--jlt-gray-light);
    }
    
    .form-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    
    .section-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--jlt-black);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .section-icon {
        width: 35px;
        height: 35px;
        background: var(--jlt-yellow);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--jlt-black);
    }
    
    /* Form Groups */
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--jlt-black);
        font-size: 0.95rem;
    }
    
    .form-label-required::after {
        content: ' *';
        color: #dc3545;
    }
    
    .form-control {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid var(--jlt-gray-light);
        border-radius: 10px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: white;
    }
    
    .form-control:focus {
        outline: none;
        border-color: var(--jlt-yellow);
        box-shadow: 0 0 0 3px rgba(244, 200, 67, 0.1);
    }
    
    .form-control.error {
        border-color: #dc3545;
    }
    
    textarea.form-control {
        resize: vertical;
        min-height: 120px;
    }
    
    .form-text {
        font-size: 0.85rem;
        color: var(--jlt-gray);
        margin-top: 0.25rem;
    }
    
    .error-message {
        color: #dc3545;
        font-size: 0.85rem;
        margin-top: 0.25rem;
    }
    
    /* Select with icon */
    .select-wrapper {
        position: relative;
    }
    
    .select-wrapper::after {
        content: '▼';
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
        color: var(--jlt-gray);
    }
    
    /* Price inputs */
    .price-input-group {
        position: relative;
    }
    
    .price-input-group::before {
        content: '$';
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--jlt-gray);
        font-weight: 600;
    }
    
    .price-input {
        padding-left: 30px;
    }
    
    /* Checkbox and Radio */
    .form-check {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .form-check-input {
        width: 20px;
        height: 20px;
        margin-right: 10px;
        cursor: pointer;
    }
    
    .form-check-label {
        cursor: pointer;
        user-select: none;
        color: var(--jlt-black);
    }
    
    .checkbox-group {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        padding: 1rem;
        background: var(--jlt-beige-light);
        border-radius: 10px;
    }
    
    /* Image Upload */
    .image-upload-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1.5rem;
    }
    
    .image-upload-box {
        position: relative;
        border: 2px dashed var(--jlt-gray-light);
        border-radius: 10px;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s ease;
        background: var(--jlt-beige-light);
        cursor: pointer;
    }
    
    .image-upload-box:hover {
        border-color: var(--jlt-yellow);
        background: white;
    }
    
    .image-upload-box.has-image {
        padding: 0;
        border-style: solid;
    }
    
    .image-preview {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 8px;
    }
    
    .upload-icon {
        font-size: 3rem;
        color: var(--jlt-gray-light);
        margin-bottom: 1rem;
    }
    
    .upload-text {
        color: var(--jlt-gray);
        font-size: 0.9rem;
    }
    
    .image-actions {
        position: absolute;
        top: 10px;
        right: 10px;
        display: flex;
        gap: 0.5rem;
    }
    
    .btn-image-action {
        width: 30px;
        height: 30px;
        background: white;
        border: 1px solid var(--jlt-gray-light);
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-image-action:hover {
        background: var(--jlt-yellow);
        border-color: var(--jlt-yellow);
    }
    
    /* Tags Input */
    .tags-input {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        padding: 10px;
        border: 2px solid var(--jlt-gray-light);
        border-radius: 10px;
        min-height: 50px;
        cursor: text;
    }
    
    .tag {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 5px 12px;
        background: var(--jlt-yellow);
        color: var(--jlt-black);
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 500;
    }
    
    .tag-remove {
        cursor: pointer;
        font-weight: bold;
    }
    
    .tag-input-field {
        border: none;
        outline: none;
        flex: 1;
        min-width: 100px;
        padding: 5px;
    }
    
    /* Status Badge */
    .status-select {
        padding-left: 40px;
    }
    
    .status-indicator {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }
    
    .status-disponible { background: #28a745; }
    .status-rupture { background: #dc3545; }
    .status-sur_commande { background: #ffc107; }
    
    /* Action Buttons */
    .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: space-between;
        padding: 2rem;
        background: var(--jlt-beige-light);
        border-top: 1px solid var(--jlt-gray-light);
    }
    
    .btn {
        padding: 12px 30px;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
    }
    
    .btn-primary {
        background: var(--jlt-yellow);
        color: var(--jlt-black);
    }
    
    .btn-primary:hover {
        background: var(--jlt-yellow-hover);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(244, 200, 67, 0.3);
    }
    
    .btn-success {
        background: var(--jlt-green);
        color: white;
    }
    
    .btn-success:hover {
        background: var(--jlt-green-dark);
        transform: translateY(-2px);
    }
    
    .btn-secondary {
        background: white;
        color: var(--jlt-gray);
        border: 2px solid var(--jlt-gray-light);
    }
    
    .btn-secondary:hover {
        background: var(--jlt-beige-light);
    }
    
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    
    .btn-danger:hover {
        background: #c82333;
    }
    
    /* Responsive Grid */
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
    }
    
    .form-grid-2 {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
    }
    
    /* Rich Text Editor Styles */
    .editor-toolbar {
        display: flex;
        gap: 0.5rem;
        padding: 10px;
        background: var(--jlt-beige-light);
        border: 2px solid var(--jlt-gray-light);
        border-bottom: none;
        border-radius: 10px 10px 0 0;
    }
    
    .editor-btn {
        padding: 5px 10px;
        background: white;
        border: 1px solid var(--jlt-gray-light);
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .editor-btn:hover {
        background: var(--jlt-yellow);
        border-color: var(--jlt-yellow);
    }
    
    .editor-content {
        min-height: 200px;
        padding: 15px;
        border: 2px solid var(--jlt-gray-light);
        border-radius: 0 0 10px 10px;
        background: white;
    }
    
    /* Success Message */
    .alert {
        padding: 15px 20px;
        border-radius: 10px;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .alert-success {
        background: #d4f4dd;
        color: #155724;
        border-left: 4px solid #28a745;
    }
    
    .alert-error {
        background: #f8d7da;
        color: #721c24;
        border-left: 4px solid #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<!-- Admin Header -->
<section class="admin-header">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 style="font-size: 2rem; margin-bottom: 0.5rem;">
                    <i class="fas fa-{% if product %}edit{% else %}plus{% endif %}"></i>
                    {% if product %}Modifier le produit{% else %}Nouveau produit{% endif %}
                </h1>
                <p style="margin: 0; opacity: 0.9;">
                    {% if product %}Modification de "{{ product.name }}"{% else %}Créer un nouveau produit dans votre catalogue{% endif %}
                </p>
            </div>
            <a href="{% url 'admin_products_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Retour à la liste
            </a>
        </div>
    </div>
</section>

<!-- Admin Navigation -->
<nav class="admin-nav">
    <div class="container">
        <div class="admin-nav-tabs">
            <a href="{% url 'admin_dashboard' %}" class="admin-nav-tab">
                <i class="fas fa-chart-line"></i> Dashboard
            </a>
            <a href="{% url 'admin_orders_list' %}" class="admin-nav-tab">
                <i class="fas fa-shopping-cart"></i> Commandes
            </a>
            <a href="{% url 'admin_products_list' %}" class="admin-nav-tab active">
                <i class="fas fa-utensils"></i> Produits
            </a>
            <a href="{% url 'admin_customers_list' %}" class="admin-nav-tab">
                <i class="fas fa-users"></i> Clients
            </a>
            <a href="{% url 'admin_reports' %}" class="admin-nav-tab">
                <i class="fas fa-chart-bar"></i> Rapports
            </a>
        </div>
    </div>
</nav>

<!-- Form Content -->
<section class="form-container">
    <div class="container">
        {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                <i class="fas fa-{% if message.tags == 'success' %}check-circle{% else %}exclamation-circle{% endif %}"></i>
                {{ message }}
            </div>
            {% endfor %}
        {% endif %}
        
        <form method="POST" enctype="multipart/form-data" id="productForm">
            {% csrf_token %}
            
            <div class="form-card">
                <div class="form-header">
                    <h2 class="form-title">
                        {% if product %}Formulaire de modification{% else %}Formulaire de création{% endif %}
                    </h2>
                </div>
                
                <div class="form-body">
                    <!-- Section 1: Informations générales -->
                    <div class="form-section">
                        <h3 class="section-title">
                            <div class="section-icon">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            Informations générales
                        </h3>
                        
                        <div class="form-grid-2">
                            <div class="form-group">
                                <label for="name" class="form-label form-label-required">Nom du produit</label>
                                <input type="text" 
                                       id="name" 
                                       name="name" 
                                       class="form-control" 
                                       value="{{ product.name|default:'' }}"
                                       placeholder="Ex: Boîte lunch végétarienne deluxe"
                                       required>
                                <span class="form-text">Le nom doit être unique et descriptif</span>
                            </div>
                            
                            <div class="form-group">
                                <label for="slug" class="form-label">Slug (URL)</label>
                                <input type="text" 
                                       id="slug" 
                                       name="slug" 
                                       class="form-control" 
                                       value="{{ product.slug|default:'' }}"
                                       placeholder="boite-lunch-vegetarienne-deluxe">
                                <span class="form-text">Laissez vide pour générer automatiquement</span>
                            </div>
                        </div>
                        
                        <div class="form-grid-2">
                            <div class="form-group">
                                <label for="category" class="form-label form-label-required">Catégorie</label>
                                <div class="select-wrapper">
                                    <select id="category" name="category" class="form-control" required>
                                        <option value="">Sélectionner une catégorie</option>
                                        {% for category in categories %}
                                        <option value="{{ category.id }}" {% if product.category.id == category.id %}selected{% endif %}>
                                            {{ category.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="status" class="form-label form-label-required">Statut</label>
                                <div class="select-wrapper" style="position: relative;">
                                    <span class="status-indicator status-{{ product.status|default:'disponible' }}"></span>
                                    <select id="status" name="status" class="form-control status-select" required onchange="updateStatusIndicator(this)">
                                        <option value="disponible" {% if product.status == 'disponible' %}selected{% endif %}>Disponible</option>
                                        <option value="rupture" {% if product.status == 'rupture' %}selected{% endif %}>Rupture de stock</option>
                                        <option value="sur_commande" {% if product.status == 'sur_commande' %}selected{% endif %}>Sur commande</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="description" class="form-label form-label-required">Description</label>
                            <div class="editor-toolbar">
                                <button type="button" class="editor-btn" onclick="formatText('bold')"><i class="fas fa-bold"></i></button>
                                <button type="button" class="editor-btn" onclick="formatText('italic')"><i class="fas fa-italic"></i></button>
                                <button type="button" class="editor-btn" onclick="formatText('underline')"><i class="fas fa-underline"></i></button>
                                <button type="button" class="editor-btn" onclick="formatText('list')"><i class="fas fa-list"></i></button>
                            </div>
                            <textarea id="description" 
                                      name="description" 
                                      class="form-control editor-content" 
                                      placeholder="Décrivez votre produit en détail..."
                                      required>{{ product.description|default:'' }}</textarea>
                        </div>
                        
                        <div class="form-grid-2">
                            <div class="form-group">
                                <label for="ingredients" class="form-label">Ingrédients</label>
                                <textarea id="ingredients" 
                                          name="ingredients" 
                                          class="form-control" 
                                          rows="3"
                                          placeholder="Liste des ingrédients séparés par des virgules">{{ product.ingredients|default:'' }}</textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="allergens" class="form-label">Allergènes</label>
                                <div class="tags-input" onclick="focusTagInput()">
                                    <input type="hidden" name="allergens" id="allergens" value="{{ product.allergens|default:'' }}">
                                    <div id="allergenTags"></div>
                                    <input type="text" 
                                           class="tag-input-field" 
                                           id="allergenInput"
                                           placeholder="Ajouter un allergène...">
                                </div>
                                <span class="form-text">Appuyez sur Entrée pour ajouter</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section 2: Prix et Stock -->
                    <div class="form-section">
                        <h3 class="section-title">
                            <div class="section-icon">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            Prix et inventaire
                        </h3>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="price" class="form-label form-label-required">Prix régulier</label>
                                <div class="price-input-group">
                                    <input type="number" 
                                           id="price" 
                                           name="price" 
                                           class="form-control price-input" 
                                           value="{{ product.price|default:'' }}"
                                           step="0.01"
                                           min="0"
                                           placeholder="0.00"
                                           required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="promo_price" class="form-label">Prix promotionnel</label>
                                <div class="price-input-group">
                                    <input type="number" 
                                           id="promo_price" 
                                           name="promo_price" 
                                           class="form-control price-input" 
                                           value="{{ product.promo_price|default:'' }}"
                                           step="0.01"
                                           min="0"
                                           placeholder="0.00">
                                </div>
                                <span class="form-text">Laissez vide si pas de promotion</span>
                            </div>
                            
                            <div class="form-group">
                                <label for="stock" class="form-label form-label-required">Stock disponible</label>
                                <input type="number" 
                                       id="stock" 
                                       name="stock" 
                                       class="form-control" 
                                       value="{{ product.stock|default:0 }}"
                                       min="0"
                                       required>
                            </div>
                            
                            <div class="form-group">
                                <label for="min_order" class="form-label">Commande minimum</label>
                                <input type="number" 
                                       id="min_order" 
                                       name="min_order" 
                                       class="form-control" 
                                       value="{{ product.min_order|default:1 }}"
                                       min="1">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section 3: Images -->
                    <div class="form-section">
                        <h3 class="section-title">
                            <div class="section-icon">
                                <i class="fas fa-image"></i>
                            </div>
                            Images du produit
                        </h3>
                        
                        <div class="image-upload-container">
                            <div class="form-group">
                                <label class="form-label form-label-required">Image principale</label>
                                <div class="image-upload-box {% if product.image %}has-image{% endif %}" onclick="document.getElementById('image').click()">
                                    {% if product.image %}
                                    <img src="{{ product.image.url }}" alt="{{ product.name }}" class="image-preview" id="preview1">
                                    <div class="image-actions">
                                        <button type="button" class="btn-image-action" onclick="changeImage(event, 'image')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                    {% else %}
                                    <div class="upload-icon">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                    </div>
                                    <div class="upload-text">
                                        Cliquez pour télécharger<br>
                                        <small>JPG, PNG • Max 5MB</small>
                                    </div>
                                    {% endif %}
                                    <input type="file" 
                                           id="image" 
                                           name="image" 
                                           accept="image/*" 
                                           style="display: none;"
                                           onchange="previewImage(event, 'preview1')"
                                           {% if not product %}required{% endif %}>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Image 2</label>
                                <div class="image-upload-box {% if product.image_2 %}has-image{% endif %}" onclick="document.getElementById('image_2').click()">
                                    {% if product.image_2 %}
                                    <img src="{{ product.image_2.url }}" alt="{{ product.name }}" class="image-preview" id="preview2">
                                    <div class="image-actions">
                                        <button type="button" class="btn-image-action" onclick="changeImage(event, 'image_2')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                    {% else %}
                                    <div class="upload-icon">
                                        <i class="fas fa-plus"></i>
                                    </div>
                                    <div class="upload-text">
                                        Image additionnelle<br>
                                        <small>Optionnel</small>
                                    </div>
                                    {% endif %}
                                    <input type="file" 
                                           id="image_2" 
                                           name="image_2" 
                                           accept="image/*" 
                                           style="display: none;"
                                           onchange="previewImage(event, 'preview2')">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Image 3</label>
                                <div class="image-upload-box {% if product.image_3 %}has-image{% endif %}" onclick="document.getElementById('image_3').click()">
                                    {% if product.image_3 %}
                                    <img src="{{ product.image_3.url }}" alt="{{ product.name }}" class="image-preview" id="preview3">
                                    <div class="image-actions">
                                        <button type="button" class="btn-image-action" onclick="changeImage(event, 'image_3')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                    {% else %}
                                    <div class="upload-icon">
                                        <i class="fas fa-plus"></i>
                                    </div>
                                    <div class="upload-text">
                                        Image additionnelle<br>
                                        <small>Optionnel</small>
                                    </div>
                                    {% endif %}
                                    <input type="file" 
                                           id="image_3" 
                                           name="image_3" 
                                           accept="image/*" 
                                           style="display: none;"
                                           onchange="previewImage(event, 'preview3')">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section 4: Informations nutritionnelles -->
                    <div class="form-section">
                        <h3 class="section-title">
                            <div class="section-icon">
                                <i class="fas fa-heartbeat"></i>
                            </div>
                            Informations nutritionnelles
                        </h3>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="calories" class="form-label">Calories</label>
                                <input type="number" 
                                       id="calories" 
                                       name="calories" 
                                       class="form-control" 
                                       value="{{ product.calories|default:'' }}"
                                       min="0"
                                       placeholder="Ex: 450">
                                <span class="form-text">Par portion</span>
                            </div>
                            
                            <div class="form-group">
                                <label for="preparation_time" class="form-label">Temps de préparation</label>
                                <input type="number" 
                                       id="preparation_time" 
                                       name="preparation_time" 
                                       class="form-control" 
                                       value="{{ product.preparation_time|default:'' }}"
                                       min="0"
                                       placeholder="Ex: 30">
                                <span class="form-text">En minutes</span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Caractéristiques diététiques</label>
                            <div class="checkbox-group">
                                <div class="form-check">
                                    <input type="checkbox" 
                                           id="is_vegetarian" 
                                           name="is_vegetarian" 
                                           class="form-check-input"
                                           {% if product.is_vegetarian %}checked{% endif %}>
                                    <label for="is_vegetarian" class="form-check-label">
                                        <i class="fas fa-leaf" style="color: #28a745;"></i> Végétarien
                                    </label>
                                </div>
                                
                                <div class="form-check">
                                    <input type="checkbox" 
                                           id="is_vegan" 
                                           name="is_vegan" 
                                           class="form-check-input"
                                           {% if product.is_vegan %}checked{% endif %}>
                                    <label for="is_vegan" class="form-check-label">
                                        <i class="fas fa-seedling" style="color: #28a745;"></i> Végane
                                    </label>
                                </div>
                                
                                <div class="form-check">
                                    <input type="checkbox" 
                                           id="is_gluten_free" 
                                           name="is_gluten_free" 
                                           class="form-check-input"
                                           {% if product.is_gluten_free %}checked{% endif %}>
                                    <label for="is_gluten_free" class="form-check-label">
                                        <i class="fas fa-bread-slice" style="color: #ffc107;"></i> Sans gluten
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section 5: Options d'affichage -->
                    <div class="form-section">
                        <h3 class="section-title">
                            <div class="section-icon">
                                <i class="fas fa-cog"></i>
                            </div>
                            Options d'affichage
                        </h3>
                        
                        <div class="checkbox-group">
                            <div class="form-check">
                                <input type="checkbox" 
                                       id="is_featured" 
                                       name="is_featured" 
                                       class="form-check-input"
                                       {% if product.is_featured %}checked{% endif %}>
                                <label for="is_featured" class="form-check-label">
                                    <i class="fas fa-star" style="color: #ffc107;"></i> Mettre en avant
                                </label>
                            </div>
                            
                            <div class="form-check">
                                <input type="checkbox" 
                                       id="is_active" 
                                       name="is_active" 
                                       class="form-check-input"
                                       {% if product.is_active or not product %}checked{% endif %}>
                                <label for="is_active" class="form-check-label">
                                    <i class="fas fa-eye" style="color: #17a2b8;"></i> Produit actif
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Form Actions -->
                <div class="form-actions">
                    <div>
                        <a href="{% url 'admin_products_list' %}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Annuler
                        </a>
                        {% if product %}
                        <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                        {% endif %}
                    </div>
                    
                    <div>
                        <button type="submit" name="save_draft" class="btn btn-secondary">
                            <i class="fas fa-save"></i> Enregistrer brouillon
                        </button>
                        <button type="submit" name="save_publish" class="btn btn-primary">
                            <i class="fas fa-check"></i> 
                            {% if product %}Mettre à jour{% else %}Publier{% endif %}
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</section>
{% endblock %}

<!-- Remplacer la section JavaScript dans product_form.html -->
{% block extra_js %}
<script>
    // Auto-generate slug from name - VERSION CORRIGÉE
    function generateSlug(text) {
        return text
            .toString()
            .toLowerCase()
            .trim()
            .normalize('NFD')                   // Normaliser les caractères Unicode
            .replace(/[\u0300-\u036f]/g, '')   // Supprimer les accents
            .replace(/[àáäâ]/g, 'a')
            .replace(/[èéëê]/g, 'e')
            .replace(/[ìíïî]/g, 'i')
            .replace(/[òóöô]/g, 'o')
            .replace(/[ùúüû]/g, 'u')
            .replace(/[ñ]/g, 'n')
            .replace(/[ç]/g, 'c')
            .replace(/[^a-z0-9\s-]/g, '')      // Supprimer les caractères spéciaux
            .replace(/\s+/g, '-')               // Remplacer les espaces par des tirets
            .replace(/-+/g, '-')                // Remplacer plusieurs tirets par un seul
            .replace(/^-+/, '')                 // Supprimer les tirets au début
            .replace(/-+$/, '');                // Supprimer les tirets à la fin
    }
    
    // Auto-génération du slug
    const nameInput = document.getElementById('name');
    const slugInput = document.getElementById('slug');
    let slugManuallyEdited = false;
    
    // Vérifier si le slug a été modifié manuellement
    slugInput.addEventListener('input', function() {
        slugManuallyEdited = true;
        // Nettoyer le slug pendant la saisie
        this.value = generateSlug(this.value);
    });
    
    // Générer le slug depuis le nom
    nameInput.addEventListener('input', function() {
        // Ne générer automatiquement que si le slug n'a pas été modifié manuellement
        // ou s'il est vide
        if (!slugManuallyEdited || !slugInput.value) {
            slugInput.value = generateSlug(this.value);
        }
    });
    
    // Forcer la génération du slug si le champ est vide lors du focus sur le slug
    slugInput.addEventListener('focus', function() {
        if (!this.value && nameInput.value) {
            this.value = generateSlug(nameInput.value);
        }
    });
    
    // Image preview - VERSION AMÉLIORÉE
    function previewImage(event, previewId) {
        const file = event.target.files[0];
        
        if (!file) return;
        
        // Vérifier la taille du fichier (5MB max)
        if (file.size > 5 * 1024 * 1024) {
            alert('L\'image est trop grande. Maximum 5MB.');
            event.target.value = '';
            return;
        }
        
        // Vérifier le type de fichier
        if (!file.type.match('image.*')) {
            alert('Veuillez sélectionner une image valide.');
            event.target.value = '';
            return;
        }
        
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const container = event.target.closest('.image-upload-box');
            const isMainImage = event.target.id === 'image';
            
            container.classList.add('has-image');
            container.innerHTML = `
                <img src="${e.target.result}" class="image-preview" id="${previewId}">
                <div class="image-actions">
                    <button type="button" class="btn-image-action" onclick="changeImage(event, '${event.target.id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    ${!isMainImage ? `
                    <button type="button" class="btn-image-action" onclick="removeImage(event, '${event.target.id}', '${previewId}')">
                        <i class="fas fa-trash"></i>
                    </button>` : ''}
                </div>
                ${event.target.outerHTML}
            `;
            
            // Réattacher l'événement au nouvel input
            const newInput = container.querySelector(`#${event.target.id}`);
            newInput.addEventListener('change', function(e) {
                previewImage(e, previewId);
            });
        };
        
        reader.readAsDataURL(file);
    }
    
    function changeImage(event, inputId) {
        event.stopPropagation();
        event.preventDefault();
        document.getElementById(inputId).click();
    }
    
    function removeImage(event, inputId, previewId) {
        event.stopPropagation();
        event.preventDefault();
        
        const container = event.target.closest('.image-upload-box');
        const isImage2 = inputId === 'image_2';
        const isImage3 = inputId === 'image_3';
        
        container.classList.remove('has-image');
        container.innerHTML = `
            <div class="upload-icon">
                <i class="fas fa-plus"></i>
            </div>
            <div class="upload-text">
                Image additionnelle<br>
                <small>Optionnel</small>
            </div>
            <input type="file" 
                   id="${inputId}" 
                   name="${inputId}" 
                   accept="image/*" 
                   style="display: none;"
                   onchange="previewImage(event, '${previewId}')">
        `;
    }
    
    // Update status indicator
    function updateStatusIndicator(select) {
        const indicator = select.parentElement.querySelector('.status-indicator');
        if (indicator) {
            indicator.className = 'status-indicator status-' + select.value;
        }
    }
    
    // Tags input for allergens - VERSION AMÉLIORÉE
    let allergens = [];
    const allergensValue = '{{ product.allergens|default:"" }}';
    if (allergensValue) {
        allergens = allergensValue.split(',').map(a => a.trim()).filter(a => a);
    }
    
    function renderAllergenTags() {
        const container = document.getElementById('allergenTags');
        container.innerHTML = allergens.map((allergen, index) => `
            <span class="tag">
                ${allergen}
                <span class="tag-remove" onclick="removeAllergen(${index})">×</span>
            </span>
        `).join('');
        document.getElementById('allergens').value = allergens.join(',');
    }
    
    function removeAllergen(index) {
        allergens.splice(index, 1);
        renderAllergenTags();
    }
    
    function focusTagInput() {
        document.getElementById('allergenInput').focus();
    }
    
    const allergenInput = document.getElementById('allergenInput');
    if (allergenInput) {
        allergenInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const value = this.value.trim();
                if (value && !allergens.includes(value)) {
                    allergens.push(value);
                    renderAllergenTags();
                    this.value = '';
                }
            }
        });
        
        // Ajouter aussi sur blur (quand on quitte le champ)
        allergenInput.addEventListener('blur', function() {
            const value = this.value.trim();
            if (value && !allergens.includes(value)) {
                allergens.push(value);
                renderAllergenTags();
                this.value = '';
            }
        });
    }
    
    // Initialize allergen tags
    if (allergens.length > 0) {
        renderAllergenTags();
    }
    
    // Rich text editor functions
    function formatText(command) {
        const textarea = document.getElementById('description');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const selectedText = textarea.value.substring(start, end);
        
        let newText = '';
        switch(command) {
            case 'bold':
                newText = selectedText ? `**${selectedText}**` : '**texte en gras**';
                break;
            case 'italic':
                newText = selectedText ? `*${selectedText}*` : '*texte en italique*';
                break;
            case 'underline':
                newText = selectedText ? `__${selectedText}__` : '__texte souligné__';
                break;
            case 'list':
                newText = selectedText ? `\n- ${selectedText}` : '\n- élément de liste';
                break;
        }
        
        if (selectedText) {
            textarea.value = textarea.value.substring(0, start) + newText + textarea.value.substring(end);
        } else {
            textarea.value = textarea.value.substring(0, start) + newText + textarea.value.substring(end);
            // Positionner le curseur pour sélectionner le texte d'exemple
            textarea.selectionStart = start;
            textarea.selectionEnd = start + newText.length;
        }
        
        textarea.focus();
    }
    
    // Confirm delete
    function confirmDelete() {
        if (confirm('Êtes-vous sûr de vouloir supprimer ce produit? Cette action est irréversible.')) {
            {% if product %}
            // Créer un formulaire pour la suppression
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{% url "admin_product_delete" product.id %}';
            
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = '{{ csrf_token }}';
            
            form.appendChild(csrfInput);
            document.body.appendChild(form);
            form.submit();
            {% endif %}
        }
    }
    
    // Form validation - VERSION AMÉLIORÉE
    document.getElementById('productForm').addEventListener('submit', function(e) {
        let isValid = true;
        const errors = [];
        
        // Vérifier le nom
        const name = document.getElementById('name').value.trim();
        if (!name) {
            errors.push('Le nom du produit est requis');
            document.getElementById('name').classList.add('error');
            isValid = false;
        }
        
        // Vérifier le slug
        const slug = document.getElementById('slug').value.trim();
        if (!slug) {
            // Générer automatiquement le slug s'il est vide
            document.getElementById('slug').value = generateSlug(name);
        }
        
        // Vérifier les prix
        const price = parseFloat(document.getElementById('price').value);
        const promoPrice = document.getElementById('promo_price').value;
        
        if (isNaN(price) || price <= 0) {
            errors.push('Le prix doit être supérieur à 0');
            document.getElementById('price').classList.add('error');
            isValid = false;
        }
        
        if (promoPrice) {
            const promoPriceFloat = parseFloat(promoPrice);
            if (promoPriceFloat >= price) {
                errors.push('Le prix promotionnel doit être inférieur au prix régulier');
                document.getElementById('promo_price').classList.add('error');
                isValid = false;
            }
        }
        
        // Vérifier la catégorie
        const category = document.getElementById('category').value;
        if (!category) {
            errors.push('Veuillez sélectionner une catégorie');
            document.getElementById('category').classList.add('error');
            isValid = false;
        }
        
        // Vérifier l'image principale pour un nouveau produit
        {% if not product %}
        const imageInput = document.getElementById('image');
        if (!imageInput.files || imageInput.files.length === 0) {
            errors.push('L\'image principale est requise');
            isValid = false;
        }
        {% endif %}
        
        if (!isValid) {
            e.preventDefault();
            alert('Veuillez corriger les erreurs suivantes:\n\n' + errors.join('\n'));
        }
    });
    
    // Retirer la classe d'erreur quand on modifie le champ
    document.querySelectorAll('.form-control').forEach(input => {
        input.addEventListener('input', function() {
            this.classList.remove('error');
        });
    });
    
    // Initialiser le statut indicator
    const statusSelect = document.getElementById('status');
    if (statusSelect) {
        updateStatusIndicator(statusSelect);
    }
</script>
{% endblock %}