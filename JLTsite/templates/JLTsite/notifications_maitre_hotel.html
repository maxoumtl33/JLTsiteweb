{% extends 'JLTsite/base_maitre_hotel.html' %}

{% block title %}Notifications - Maître d'Hôtel{% endblock %}

{% block page_title %}Notifications{% endblock %}

{% block page_actions %}
    <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-success" onclick="markAllAsRead()">
            <i class="fas fa-check-double me-1"></i>
            Tout marquer comme lu
        </button>
        <button type="button" class="btn btn-outline-primary" onclick="location.reload()">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>
{% endblock %}

{% block content %}
    <!-- Statistics -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card stat-card">
                <div class="card-body text-center">
                    <i class="fas fa-bell fa-2x mb-2"></i>
                    <h3 class="mb-1">{{ stats.total }}</h3>
                    <p class="mb-0">Total</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card stat-card warning">
                <div class="card-body text-center">
                    <i class="fas fa-envelope fa-2x mb-2"></i>
                    <h3 class="mb-1">{{ stats.unread }}</h3>
                    <p class="mb-0">Non lues</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card stat-card danger">
                <div class="card-body text-center">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <h3 class="mb-1">{{ stats.urgent }}</h3>
                    <p class="mb-0">Urgentes</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card stat-card success">
                <div class="card-body text-center">
                    <i class="fas fa-check fa-2x mb-2"></i>
                    <h3 class="mb-1">{{ stats.total|add:"-"|add:stats.unread }}</h3>
                    <p class="mb-0">Lues</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="type" class="form-label">Type</label>
                    <select name="type" id="type" class="form-select">
                        <option value="all" {% if filter_type == 'all' %}selected{% endif %}>Tous les types</option>
                        {% for value, label in notification_types %}
                            <option value="{{ value }}" {% if filter_type == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-4">
                    <label for="read" class="form-label">État</label>
                    <select name="read" id="read" class="form-select">
                        <option value="all" {% if filter_read == 'all' %}selected{% endif %}>Toutes</option>
                        <option value="unread" {% if filter_read == 'unread' %}selected{% endif %}>Non lues</option>
                        <option value="read" {% if filter_read == 'read' %}selected{% endif %}>Lues</option>
                    </select>
                </div>
                
                <div class="col-md-4">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-filter me-1"></i>
                        Filtrer
                    </button>
                    <a href="{% url 'maitre_hotel_notifications' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-1"></i>
                        Reset
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Notifications List -->
    <div class="card">
        <div class="card-body p-0">
            {% if notifications %}
                {% for notification in notifications %}
                    <div class="notification-item border-bottom p-3 {% if not notification.is_read %}bg-light{% endif %}" 
                         data-notification-id="{{ notification.id }}">
                        <div class="d-flex align-items-start">
                            <div class="me-3">
                                <i class="{{ notification.get_icon }} fa-2x {{ notification.get_color_class }}"></i>
                            </div>
                            
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="mb-0 {% if not notification.is_read %}fw-bold{% endif %}">
                                        {{ notification.title }}
                                        {% if notification.is_urgent %}
                                            <span class="badge bg-danger ms-1">URGENT</span>
                                        {% endif %}
                                        {% if not notification.is_read %}
                                            <span class="badge bg-primary ms-1">NOUVEAU</span>
                                        {% endif %}
                                    </h6>
                                    <small class="text-muted">{{ notification.created_at|timesince }} ago</small>
                                </div>
                                
                                <p class="mb-2 text-muted">{{ notification.message }}</p>
                                
                                {% if notification.event %}
                                    <div class="mb-2">
                                        <small class="text-info">
                                            <i class="fas fa-calendar me-1"></i>
                                            Événement: {{ notification.event.event_name }}
                                        </small>
                                    </div>
                                {% endif %}
                                
                                <div class="d-flex gap-2">
                                    {% if not notification.is_read %}
                                        <button class="btn btn-sm btn-outline-primary" 
                                                onclick="markAsRead({{ notification.id }})">
                                            <i class="fas fa-check me-1"></i>
                                            Marquer comme lu
                                        </button>
                                    {% endif %}
                                    
                                    {% if notification.event %}
                                        <a href="{% url 'maitre_hotel_event_detail' notification.event.id %}" 
                                           class="btn btn-sm btn-outline-info">
                                            <i class="fas fa-eye me-1"></i>
                                            Voir événement
                                        </a>
                                    {% endif %}
                                    
                                    <small class="text-muted align-self-center">
                                        <span class="badge bg-secondary">{{ notification.get_type_display }}</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
                
                <!-- Pagination -->
                {% if notifications.has_other_pages %}
                    <div class="p-3">
                        <nav>
                            <ul class="pagination justify-content-center mb-0">
                                {% if notifications.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ notifications.previous_page_number }}&type={{ filter_type }}&read={{ filter_read }}">
                                            Précédent
                                        </a>
                                    </li>
                                {% endif %}
                                
                                {% for num in notifications.paginator.page_range %}
                                    {% if notifications.number == num %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ num }}</span>
                                        </li>
                                    {% elif num > notifications.number|add:'-3' and num < notifications.number|add:'3' %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ num }}&type={{ filter_type }}&read={{ filter_read }}">{{ num }}</a>
                                        </li>
                                    {% endif %}
                                {% endfor %}
                                
                                {% if notifications.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ notifications.next_page_number }}&type={{ filter_type }}&read={{ filter_read }}">
                                            Suivant
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                {% endif %}
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Aucune notification</h5>
                    <p class="text-muted">Vous n'avez aucune notification pour le moment.</p>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    function markAsRead(notificationId) {
        $.post(`/maitre-hotel/notification/${notificationId}/read/`)
            .done(function(data) {
                if (data.success) {
                    const item = $(`[data-notification-id="${notificationId}"]`);
                    item.removeClass('bg-light');
                    item.find('.fw-bold').removeClass('fw-bold');
                    item.find('.badge:contains("NOUVEAU")').remove();
                    item.find('button:contains("Marquer comme lu")').remove();
                    
                    // Update stats
                    updateStats();
                } else {
                    alert(data.message);
                }
            })
            .fail(function() {
                alert('Erreur lors du marquage de la notification');
            });
    }

    function markAllAsRead() {
        if (confirm('Marquer toutes les notifications comme lues ?')) {
            $.post('/maitre-hotel/notifications/mark-all-read/')
                .done(function(data) {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert(data.message);
                    }
                })
                .fail(function() {
                    alert('Erreur lors du marquage des notifications');
                });
        }
    }

    function updateStats() {
        // Simple stats update - you might want to make an AJAX call to get real stats
        let unreadCount = $('.notification-item.bg-light').length;
        $('.stat-card.warning h3').text(unreadCount);
    }

    // Auto-refresh every 2 minutes
    setInterval(() => {
        location.reload();
    }, 120000);
</script>
{% endblock %}