<!-- templates/JLTsite/admin_manual_order.html -->
{% extends 'JLTsite/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Cr√©er une Commande Manuelle - Julien-Leblanc Traiteur{% endblock %}

{% block extra_css %}
<style>
    /* Variables CSS */
    :root {
        --jlt-yellow: #F4C843;
        --jlt-yellow-hover: #e6b835;
        --jlt-black: #1a1a1a;
        --jlt-gray: #6c757d;
        --jlt-gray-light: #e9ecef;
        --jlt-beige: #f8f9fa;
        --jlt-beige-light: #fafbfc;
    }

    /* Admin Header */
    .admin-header {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        padding: 2rem 0;
        position: relative;
        overflow: hidden;
    }
    
    .admin-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 60%;
        height: 200%;
        background: radial-gradient(circle, rgba(244, 200, 67, 0.1) 0%, transparent 70%);
        animation: float 20s ease-in-out infinite;
    }
    
    @keyframes float {
        0%, 100% { transform: translateY(0) rotate(0deg); }
        50% { transform: translateY(-20px) rotate(10deg); }
    }
    
    .admin-title {
        color: white;
        font-size: 2rem;
        margin-bottom: 0.5rem;
        position: relative;
        z-index: 1;
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .admin-subtitle {
        color: rgba(255, 255, 255, 0.9);
        font-size: 1rem;
        position: relative;
        z-index: 1;
    }
    
    /* Admin Navigation */
    .admin-nav {
        background: #34495e;
        border-bottom: 3px solid var(--jlt-yellow);
        position: sticky;
        top: 0;
        z-index: 100;
    }
    
    .admin-nav-tabs {
        display: flex;
        gap: 0;
        margin: 0;
        padding: 0;
        overflow-x: auto;
    }
    
    .admin-nav-tab {
        padding: 1rem 1.5rem;
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        border-bottom: 3px solid transparent;
    }
    
    .admin-nav-tab:hover {
        background: rgba(255, 255, 255, 0.05);
        color: white;
    }
    
    .admin-nav-tab.active {
        background: rgba(244, 200, 67, 0.1);
        color: var(--jlt-yellow);
        border-bottom-color: var(--jlt-yellow);
    }
    
    /* Form Container */
    .form-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 3px 15px rgba(0,0,0,0.08);
        overflow: hidden;
    }
    
    .form-header {
        background: linear-gradient(135deg, var(--jlt-beige) 0%, var(--jlt-beige-light) 100%);
        padding: 1.5rem;
        border-bottom: 3px solid var(--jlt-yellow);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .form-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--jlt-black);
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .form-title-icon {
        width: 40px;
        height: 40px;
        background: var(--jlt-yellow);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .form-badge {
        background: white;
        color: var(--jlt-gray);
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 500;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    /* Form Steps */
    .step-section {
        padding: 2rem;
        border-bottom: 1px solid var(--jlt-gray-light);
    }
    
    .step-section:last-child {
        border-bottom: none;
    }
    
    .step-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--jlt-beige);
    }
    
    .step-number {
        width: 35px;
        height: 35px;
        background: var(--jlt-yellow);
        color: var(--jlt-black);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.1rem;
    }
    
    .step-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--jlt-black);
    }
    
    /* Customer Selection */
    .customer-type-selector {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .customer-type-option {
        flex: 1;
        padding: 1rem;
        border: 2px solid var(--jlt-gray-light);
        border-radius: 10px;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }
    
    .customer-type-option:hover {
        border-color: var(--jlt-yellow);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .customer-type-option.active {
        background: var(--jlt-yellow);
        border-color: var(--jlt-yellow);
        color: var(--jlt-black);
    }
    
    .customer-type-option input[type="radio"] {
        display: none;
    }
    
    .customer-type-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }
    
    .customer-type-label {
        font-weight: 600;
        font-size: 1rem;
    }
    
    /* Form Controls */
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-label {
        display: block;
        font-weight: 600;
        color: var(--jlt-gray);
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }
    
    .form-control {
        width: 100%;
        padding: 10px 15px;
        border: 2px solid var(--jlt-gray-light);
        border-radius: 10px;
        font-size: 1rem;
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        outline: none;
        border-color: var(--jlt-yellow);
        box-shadow: 0 0 0 3px rgba(244, 200, 67, 0.1);
    }
    
    select.form-control {
        cursor: pointer;
    }
    
    .customer-info-display {
        background: linear-gradient(135deg, #d1ecf1 0%, #b8daff 100%);
        border-radius: 10px;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .customer-info-display strong {
        color: #004085;
    }
    
    /* Product Selection */
    .products-section {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
    }
    
    .categories-tabs {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .category-tabs-nav {
        display: flex;
        background: var(--jlt-beige);
        overflow-x: auto;
        border-bottom: 2px solid var(--jlt-gray-light);
    }
    
    .category-tab {
        padding: 1rem 1.5rem;
        background: transparent;
        border: none;
        color: var(--jlt-gray);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
        border-bottom: 3px solid transparent;
        margin-bottom: -2px;
    }
    
    .category-tab:hover {
        background: var(--jlt-beige-light);
        color: var(--jlt-black);
    }
    
    .category-tab.active {
        background: white;
        color: var(--jlt-black);
        border-bottom-color: var(--jlt-yellow);
    }
    
    .category-content {
        padding: 1.5rem;
        max-height: 500px;
        overflow-y: auto;
    }
    
    .category-content::-webkit-scrollbar {
        width: 8px;
    }
    
    .category-content::-webkit-scrollbar-track {
        background: var(--jlt-beige-light);
        border-radius: 10px;
    }
    
    .category-content::-webkit-scrollbar-thumb {
        background: var(--jlt-gray-light);
        border-radius: 10px;
    }
    
    .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1rem;
    }
    
    .product-item {
        background: white;
        border: 2px solid var(--jlt-gray-light);
        border-radius: 10px;
        padding: 1rem;
        transition: all 0.3s ease;
    }
    
    .product-item:hover {
        border-color: var(--jlt-yellow);
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .product-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 0.5rem;
    }
    
    .product-name {
        font-weight: 600;
        color: var(--jlt-black);
        margin-bottom: 0.25rem;
    }
    
    .product-price {
        color: var(--jlt-yellow);
        font-weight: 700;
        font-size: 1.1rem;
    }
    
    .product-stock {
        background: #fff3cd;
        color: #856404;
        padding: 3px 8px;
        border-radius: 5px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-top: 0.5rem;
        display: inline-block;
    }
    
    .btn-add-product {
        width: 35px;
        height: 35px;
        background: var(--jlt-yellow);
        border: none;
        border-radius: 50%;
        color: var(--jlt-black);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-add-product:hover {
        background: var(--jlt-yellow-hover);
        transform: scale(1.1);
        box-shadow: 0 3px 10px rgba(244, 200, 67, 0.4);
    }
    
    /* Cart */
    .cart-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 3px 15px rgba(0,0,0,0.08);
        position: sticky;
        top: 20px;
        overflow: hidden;
    }
    
    .cart-header {
        background: linear-gradient(135deg, var(--jlt-yellow) 0%, #ffd966 100%);
        color: var(--jlt-black);
        padding: 1rem 1.5rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .cart-body {
        padding: 1.5rem;
        max-height: 400px;
        overflow-y: auto;
    }
    
    .cart-empty {
        text-align: center;
        padding: 2rem;
        color: var(--jlt-gray);
    }
    
    .cart-empty-icon {
        font-size: 3rem;
        color: var(--jlt-gray-light);
        margin-bottom: 1rem;
    }
    
    .cart-item {
        background: var(--jlt-beige-light);
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }
    
    .cart-item:hover {
        background: var(--jlt-beige);
        transform: translateX(5px);
    }
    
    .cart-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .cart-item-name {
        font-weight: 600;
        color: var(--jlt-black);
    }
    
    .cart-item-price {
        color: var(--jlt-gray);
        font-size: 0.9rem;
    }
    
    .cart-item-controls {
        display: flex;
        gap: 0.5rem;
    }
    
    .btn-cart {
        width: 28px;
        height: 28px;
        border: 1px solid var(--jlt-gray-light);
        background: white;
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        color: var(--jlt-gray);
    }
    
    .btn-cart:hover {
        background: var(--jlt-yellow);
        border-color: var(--jlt-yellow);
        color: var(--jlt-black);
    }
    
    .btn-cart.danger:hover {
        background: #dc3545;
        border-color: #dc3545;
        color: white;
    }
    
    .cart-item-notes {
        margin-top: 0.5rem;
    }
    
    .cart-item-notes input {
        width: 100%;
        padding: 5px 10px;
        border: 1px solid var(--jlt-gray-light);
        border-radius: 5px;
        font-size: 0.9rem;
    }
    
    /* Cart Totals */
    .cart-totals {
        padding: 1.5rem;
        background: var(--jlt-beige-light);
        border-top: 2px solid var(--jlt-gray-light);
    }
    
    .total-line {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.75rem;
        color: var(--jlt-gray);
    }
    
    .total-line.total {
        font-weight: 700;
        font-size: 1.2rem;
        color: var(--jlt-black);
        padding-top: 0.75rem;
        border-top: 2px solid var(--jlt-gray-light);
    }
    
    /* Delivery Section */
    .delivery-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }
    
    .delivery-address-section {
        background: var(--jlt-beige-light);
        border-radius: 10px;
        padding: 1.5rem;
        margin-top: 1rem;
    }
    
    /* Action Buttons */
    .form-actions {
        padding: 2rem;
        background: var(--jlt-beige-light);
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-top: 2px solid var(--jlt-gray-light);
    }
    
    .btn-action {
        padding: 12px 24px;
        border-radius: 10px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        border: none;
        cursor: pointer;
    }
    
    .btn-action.primary {
        background: var(--jlt-yellow);
        color: var(--jlt-black);
    }
    
    .btn-action.primary:hover {
        background: var(--jlt-yellow-hover);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(244, 200, 67, 0.4);
    }
    
    .btn-action.success {
        background: #28a745;
        color: white;
    }
    
    .btn-action.success:hover {
        background: #218838;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
    }
    
    .btn-action.secondary {
        background: white;
        color: var(--jlt-gray);
        border: 2px solid var(--jlt-gray-light);
    }
    
    .btn-action.secondary:hover {
        background: var(--jlt-beige);
        border-color: var(--jlt-gray);
    }
    
    /* Responsive */
    @media (max-width: 992px) {
        .products-section {
            grid-template-columns: 1fr;
        }
        
        .cart-container {
            position: static;
            margin-top: 2rem;
        }
    }
    
    @media (max-width: 768px) {
        .customer-type-selector {
            flex-direction: column;
        }
        
        .products-grid {
            grid-template-columns: 1fr;
        }
        
        .delivery-options {
            grid-template-columns: 1fr;
        }
        
        .form-actions {
            flex-direction: column;
            gap: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Admin Header -->
<section class="admin-header">
    <div class="container">
        <h1 class="admin-title">
            <i class="fas fa-phone-alt"></i> 
            Nouvelle Commande Manuelle
        </h1>
        <p class="admin-subtitle">Cr√©ation de commande par t√©l√©phone ou sur place</p>
    </div>
</section>

<!-- Admin Navigation -->
<nav class="admin-nav">
    <div class="container">
        <div class="admin-nav-tabs">
            <a href="{% url 'admin_dashboard' %}" class="admin-nav-tab">
                <i class="fas fa-chart-line"></i> Dashboard
            </a>
            <a href="{% url 'admin_orders_calendar' %}" class="admin-nav-tab">
                <i class="fas fa-calendar-alt"></i> Calendrier
            </a>
            <a href="{% url 'admin_orders_list' %}" class="admin-nav-tab active">
                <i class="fas fa-shopping-cart"></i> Commandes
            </a>
            <a href="{% url 'admin_products_list' %}" class="admin-nav-tab">
                <i class="fas fa-utensils"></i> Produits
            </a>
            <a href="{% url 'admin_customers_list' %}" class="admin-nav-tab">
                <i class="fas fa-users"></i> Clients
            </a>
            <a href="{% url 'admin_reports' %}" class="admin-nav-tab">
                <i class="fas fa-chart-bar"></i> Rapports
            </a>
            <a href="{% url 'admin_kitchen_dispatch' %}" class="admin-nav-tab">
                <i class="fas fa-clipboard-list"></i> Dispatch
            </a>
        </div>
    </div>
</nav>

<!-- Content -->
<section class="admin-content" style="background: var(--jlt-beige); padding: 2rem 0; min-height: calc(100vh - 300px);">
    <div class="container">
        <div class="form-container">
            <div class="form-header">
                <div class="form-title">
                    <div class="form-title-icon">
                        <i class="fas fa-phone-alt"></i>
                    </div>
                    <span>Nouvelle Commande Manuelle</span>
                </div>
                <div class="form-badge">
                    <i class="fas fa-user"></i> {{ request.user.get_full_name }} - {% now "d/m/Y H:i" %}
                </div>
            </div>
            
            <form method="post" id="manualOrderForm">
                {% csrf_token %}
                
                <!-- √âtape 1: Client -->
                <div class="step-section">
                    <div class="step-header">
                        <div class="step-number">1</div>
                        <div class="step-title">Informations Client</div>
                    </div>
                    
                    <div class="customer-type-selector">
                        <label class="customer-type-option active">
                            <input type="radio" name="customer_type" value="existing" checked>
                            <div class="customer-type-icon">üë§</div>
                            <div class="customer-type-label">Client Existant</div>
                        </label>
                        <label class="customer-type-option">
                            <input type="radio" name="customer_type" value="new">
                            <div class="customer-type-icon">‚ûï</div>
                            <div class="customer-type-label">Nouveau Client</div>
                        </label>
                    </div>
                    
                    <!-- Client existant -->
                    <div id="existing_customer_section">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Rechercher un client</label>
                                    <select class="form-control" name="customer_id" id="customer_select">
                                        <option value="">-- S√©lectionner un client --</option>
                                        {% for customer in customers %}
                                        <option value="{{ customer.id }}" 
                                                data-phone="{{ customer.phone }}"
                                                data-email="{{ customer.email }}"
                                                data-company="{{ customer.company }}">
                                            {{ customer.last_name }} {{ customer.first_name }} 
                                            {% if customer.company %}({{ customer.company }}){% endif %}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="customer-info-display d-none" id="customer_info">
                                    <strong>Client s√©lectionn√©:</strong><br>
                                    <span id="selected_customer_info"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Nouveau client -->
                    <div id="new_customer_section" style="display: none;">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="form-label">Pr√©nom *</label>
                                    <input type="text" class="form-control" name="first_name" id="first_name">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="form-label">Nom *</label>
                                    <input type="text" class="form-control" name="last_name" id="last_name">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="form-label">T√©l√©phone *</label>
                                    <input type="text" class="form-control" name="phone" id="phone" 
                                           placeholder="514-XXX-XXXX">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" name="email" id="email">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Entreprise</label>
                                    <input type="text" class="form-control" name="company" id="company">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group" style="padding-top: 2rem;">
                                    <label style="cursor: pointer;">
                                        <input type="checkbox" name="create_account" id="create_account" style="margin-right: 0.5rem;">
                                        Cr√©er un compte client (envoi d'email avec identifiants)
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- √âtape 2: Produits -->
                <div class="step-section">
                    <div class="step-header">
                        <div class="step-number">2</div>
                        <div class="step-title">S√©lection des Produits</div>
                    </div>
                    
                    <div class="products-section">
                        <div class="categories-tabs">
                            <div class="category-tabs-nav">
                                {% for category in categories %}
                                <button type="button" class="category-tab {% if forloop.first %}active{% endif %}" 
                                        onclick="showCategory('cat_{{ category.id }}', this)">
                                    {{ category.name }}
                                </button>
                                {% endfor %}
                            </div>
                            
                            {% for category in categories %}
                            <div class="category-content" id="cat_{{ category.id }}" 
                                 {% if not forloop.first %}style="display: none;"{% endif %}>
                                <div class="products-grid">
                                    {% for product in category.products.all %}
                                    <div class="product-item">
                                        <div class="product-header">
                                            <div>
                                                <div class="product-name">{{ product.name }}</div>
                                                <div class="product-price">{{ product.price }}$</div>
                                                {% if product.stock < 10 %}
                                                <span class="product-stock">Stock: {{ product.stock }}</span>
                                                {% endif %}
                                            </div>
                                            <button type="button" class="btn-add-product"
                                                    data-product-id="{{ product.id }}"
                                                    data-product-name="{{ product.name }}"
                                                    data-product-price="{{ product.get_price }}"
                                                    data-product-stock="{{ product.stock }}">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <div class="cart-container">
                            <div class="cart-header">
                                <i class="fas fa-shopping-cart"></i> Commande
                            </div>
                            <div class="cart-body">
                                <div id="cart-items">
                                    <div class="cart-empty">
                                        <div class="cart-empty-icon">
                                            <i class="fas fa-shopping-basket"></i>
                                        </div>
                                        <div>Aucun produit s√©lectionn√©</div>
                                    </div>
                                </div>
                            </div>
                            <div class="cart-totals">
                                <div class="total-line">
                                    <span>Sous-total:</span>
                                    <span id="subtotal">0.00$</span>
                                </div>
                                <div class="total-line">
                                    <span>TPS/TVQ (14.975%):</span>
                                    <span id="tax">0.00$</span>
                                </div>
                                <div class="total-line" id="delivery-fee-row" style="display:none;">
                                    <span>Livraison:</span>
                                    <span id="delivery-fee">0.00$</span>
                                </div>
                                <div class="total-line total">
                                    <span>Total:</span>
                                    <span id="total">0.00$</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- √âtape 3: Livraison -->
                <div class="step-section">
                    <div class="step-header">
                        <div class="step-number">3</div>
                        <div class="step-title">Informations de Livraison</div>
                    </div>
                    
                    <div class="delivery-options">
                        <div class="form-group">
                            <label class="form-label">Type de livraison</label>
                            <select class="form-control" name="delivery_type" id="delivery_type">
                                <option value="pickup">üè™ Ramassage</option>
                                <option value="delivery">üì¶ Livraison</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date de livraison *</label>
                            <select class="form-control" name="delivery_date" required>
                                {% for date in delivery_dates %}
                                <option value="{{ date.value }}">{{ date.display }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Heure de livraison *</label>
                            <select class="form-control" name="delivery_time" required>
                                {% for slot in delivery_times %}
                                <option value="{{ slot.value }}">{{ slot.display }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">M√©thode de paiement</label>
                            <select class="form-control" name="payment_method">
                                <option value="cash">üíµ Comptant</option>
                                <option value="credit">üí≥ Carte de cr√©dit</option>
                                <option value="debit">üí≥ D√©bit</option>
                                <option value="check">üìù Ch√®que</option>
                                <option value="invoice">üìÑ Facture</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="delivery_address_section" class="delivery-address-section" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Adresse de livraison</label>
                                    <textarea class="form-control" name="delivery_address" rows="2"></textarea>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="form-label">Code postal</label>
                                    <input type="text" class="form-control" name="delivery_postal_code" 
                                           placeholder="H0H 0H0">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="form-label">Ville</label>
                                    <input type="text" class="form-control" name="delivery_city" 
                                           value="Montr√©al">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Notes de livraison</label>
                        <textarea class="form-control" name="delivery_notes" rows="3" 
                                  placeholder="Instructions sp√©ciales, allergies, etc."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label style="cursor: pointer;">
                            <input type="checkbox" name="mark_as_paid" id="mark_as_paid" style="margin-right: 0.5rem;">
                            Marquer comme pay√©e
                        </label>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="form-actions">
                    <a href="{% url 'admin_dashboard' %}" class="btn-action secondary">
                        <i class="fas fa-arrow-left"></i> Annuler
                    </a>
                    <div style="display: flex; gap: 1rem;">
                        <button type="submit" name="action" value="save_and_new" class="btn-action success">
                            <i class="fas fa-save"></i> Enregistrer et Nouvelle
                        </button>
                        <button type="submit" name="action" value="save" class="btn-action primary">
                            <i class="fas fa-check"></i> Enregistrer la Commande
                        </button>
                    </div>
                </div>
                
                <!-- Champ cach√© pour les produits -->
                <input type="hidden" name="products_data" id="products_data">
            </form>
        </div>
    </div>
</section>

<script>
// Gestion du formulaire
document.addEventListener('DOMContentLoaded', function() {
    let cart = [];
    let subtotal = 0;
    
    // Changement type de client
    document.querySelectorAll('.customer-type-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.customer-type-option').forEach(o => o.classList.remove('active'));
            this.classList.add('active');
            
            const value = this.querySelector('input').value;
            if (value === 'existing') {
                document.getElementById('existing_customer_section').style.display = 'block';
                document.getElementById('new_customer_section').style.display = 'none';
            } else {
                document.getElementById('existing_customer_section').style.display = 'none';
                document.getElementById('new_customer_section').style.display = 'block';
            }
        });
    });
    
    // S√©lection client existant
    document.getElementById('customer_select').addEventListener('change', function() {
        const selected = this.options[this.selectedIndex];
        if (selected.value) {
            const info = `${selected.text}<br>
                         T√©l: ${selected.dataset.phone || 'N/A'}<br>
                         Email: ${selected.dataset.email || 'N/A'}`;
            document.getElementById('selected_customer_info').innerHTML = info;
            document.getElementById('customer_info').classList.remove('d-none');
        } else {
            document.getElementById('customer_info').classList.add('d-none');
        }
    });
    
    // Ajout de produit
    document.querySelectorAll('.btn-add-product').forEach(btn => {
        btn.addEventListener('click', function() {
            const productId = this.dataset.productId;
            const productName = this.dataset.productName;
            const productPrice = parseFloat(this.dataset.productPrice);
            const productStock = parseInt(this.dataset.productStock);
            
            const existingItem = cart.find(item => item.product_id === productId);
            
            if (existingItem) {
                if (existingItem.quantity < productStock) {
                    existingItem.quantity++;
                } else {
                    alert('Stock insuffisant');
                    return;
                }
            } else {
                cart.push({
                    product_id: productId,
                    name: productName,
                    price: productPrice,
                    quantity: 1,
                    stock: productStock,
                    notes: ''
                });
            }
            
            updateCartDisplay();
        });
    });
    
    // Mise √† jour du panier
    function updateCartDisplay() {
        const cartDiv = document.getElementById('cart-items');
        
        if (cart.length === 0) {
            cartDiv.innerHTML = `
                <div class="cart-empty">
                    <div class="cart-empty-icon">
                        <i class="fas fa-shopping-basket"></i>
                    </div>
                    <div>Aucun produit s√©lectionn√©</div>
                </div>`;
            subtotal = 0;
        } else {
            let html = '';
            subtotal = 0;
            
            cart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                
                html += `
                    <div class="cart-item">
                        <div class="cart-item-header">
                            <div>
                                <div class="cart-item-name">${item.name}</div>
                                <div class="cart-item-price">${item.price}$ √ó ${item.quantity} = ${itemTotal.toFixed(2)}$</div>
                            </div>
                            <div class="cart-item-controls">
                                <button type="button" class="btn-cart" onclick="updateQuantity(${index}, -1)">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <button type="button" class="btn-cart" onclick="updateQuantity(${index}, 1)">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button type="button" class="btn-cart danger" onclick="removeFromCart(${index})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="cart-item-notes">
                            <input type="text" placeholder="Notes sp√©ciales" 
                                   onchange="updateNotes(${index}, this.value)">
                        </div>
                    </div>`;
            });
            
            cartDiv.innerHTML = html;
        }
        
        // Mise √† jour des totaux
        const tax = subtotal * 0.14975;
        const deliveryFee = document.getElementById('delivery_type').value === 'delivery' && subtotal < 50 ? 5 : 0;
        const total = subtotal + tax + deliveryFee;
        
        document.getElementById('subtotal').textContent = subtotal.toFixed(2) + '$';
        document.getElementById('tax').textContent = tax.toFixed(2) + '$';
        document.getElementById('delivery-fee').textContent = deliveryFee.toFixed(2) + '$';
        document.getElementById('total').textContent = total.toFixed(2) + '$';
        
        document.getElementById('products_data').value = JSON.stringify(cart);
    }
    
    // Fonctions globales
    window.updateQuantity = function(index, delta) {
        if (cart[index].quantity + delta > 0 && cart[index].quantity + delta <= cart[index].stock) {
            cart[index].quantity += delta;
            updateCartDisplay();
        }
    };
    
    window.removeFromCart = function(index) {
        cart.splice(index, 1);
        updateCartDisplay();
    };
    
    window.updateNotes = function(index, notes) {
        cart[index].notes = notes;
    };
    
    window.showCategory = function(categoryId, button) {
        document.querySelectorAll('.category-content').forEach(content => {
            content.style.display = 'none';
        });
        document.querySelectorAll('.category-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        document.getElementById(categoryId).style.display = 'block';
        button.classList.add('active');
    };
    
    // Type de livraison
    document.getElementById('delivery_type').addEventListener('change', function() {
        const isDelivery = this.value === 'delivery';
        document.getElementById('delivery_address_section').style.display = isDelivery ? 'block' : 'none';
        document.getElementById('delivery-fee-row').style.display = isDelivery ? 'flex' : 'none';
        updateCartDisplay();
    });
    
    // Validation
    document.getElementById('manualOrderForm').addEventListener('submit', function(e) {
        if (cart.length === 0) {
            e.preventDefault();
            alert('Veuillez ajouter au moins un produit √† la commande');
            return false;
        }
        
        const customerType = document.querySelector('input[name="customer_type"]:checked').value;
        if (customerType === 'existing') {
            if (!document.getElementById('customer_select').value) {
                e.preventDefault();
                alert('Veuillez s√©lectionner un client');
                return false;
            }
        } else {
            if (!document.getElementById('first_name').value || !document.getElementById('last_name').value) {
                e.preventDefault();
                alert('Veuillez remplir les informations du client');
                return false;
            }
        }
    });
});
</script>

{% endblock %}