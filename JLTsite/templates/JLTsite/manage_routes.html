{% extends 'JLTsite/base.html' %}
{% load static %}

{% block title %}Gérer les routes - {{ selected_date|date:"d/m/Y" }}{% endblock %}

{% block extra_css %}
<style>
    :root {
        --route-primary: #4a90e2;
        --route-secondary: #357abd;
        --route-success: #5cb85c;
        --route-warning: #f0ad4e;
        --route-danger: #d9534f;
    }

    .manage-routes-page {
        background: #f5f7fa;
        min-height: 100vh;
        padding: 20px;
    }

    .page-header {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .routes-grid {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 30px;
    }

    .unassigned-section {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        max-height: 80vh;
        overflow-y: auto;
    }

    .routes-section {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .delivery-card {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
        cursor: move;
        transition: all 0.3s ease;
        border-left: 4px solid var(--route-primary);
    }

    .delivery-card:hover {
        transform: translateX(5px);
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .delivery-card.dragging {
        opacity: 0.5;
    }

    .delivery-card.priority-urgent {
        border-left-color: var(--route-danger);
        background: #fff5f5;
    }

    .delivery-card.priority-high {
        border-left-color: var(--route-warning);
    }

    .route-box {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        border: 2px solid #e0e0e0;
    }

    .route-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 15px;
        border-bottom: 2px solid #e0e0e0;
        margin-bottom: 15px;
    }

    .route-deliveries-area {
        min-height: 150px;
        background: white;
        border-radius: 8px;
        padding: 15px;
        border: 2px dashed #ddd;
    }

    .route-deliveries-area.drag-over {
        background: #e8f4f8;
        border-color: var(--route-primary);
    }

    .driver-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .driver-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--route-primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }

    .route-stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #e0e0e0;
    }

    .stat-item {
        text-align: center;
    }

    .stat-value {
        font-size: 1.5em;
        font-weight: bold;
        color: var(--route-primary);
    }

    .stat-label {
        font-size: 0.85em;
        color: #666;
    }

    .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .btn-route {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-route-primary {
        background: var(--route-primary);
        color: white;
    }

    .btn-route-primary:hover {
        background: var(--route-secondary);
        transform: translateY(-2px);
    }

    .empty-state {
        text-align: center;
        padding: 40px;
        color: #999;
    }

    .empty-state i {
        font-size: 3em;
        margin-bottom: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="manage-routes-page">
    <!-- Header -->
    <div class="page-header">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h1><i class="fas fa-route"></i> Gestion des routes</h1>
                <p class="text-muted mb-0">Organisez les livraisons par route et livreur</p>
            </div>
            <div class="col-md-6 text-right">
                <input type="date" class="form-control d-inline-block w-auto" 
                       value="{{ selected_date|date:'Y-m-d' }}"
                       onchange="window.location.href='?date=' + this.value">
                <button class="btn btn-primary ml-2" onclick="createNewRoute()">
                    <i class="fas fa-plus"></i> Nouvelle route
                </button>
            </div>
        </div>
    </div>

    <!-- Grille principale -->
    <div class="routes-grid">
        <!-- Livraisons non assignées -->
        <div class="unassigned-section">
            <h3 class="mb-3">
                <i class="fas fa-boxes"></i> Livraisons non assignées
                <span class="badge badge-secondary float-right">{{ unassigned_deliveries.count }}</span>
            </h3>
            
            <div id="unassigned-list">
                {% for delivery in unassigned_deliveries %}
                <div class="delivery-card priority-{{ delivery.priority }}"
                     draggable="true"
                     ondragstart="drag(event)"
                     data-delivery-id="{{ delivery.id }}">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <strong>{{ delivery.customer_name }}</strong>
                        {% if delivery.priority == 'urgent' %}
                        <span class="badge badge-danger">URGENT</span>
                        {% elif delivery.priority == 'high' %}
                        <span class="badge badge-warning">Priorité haute</span>
                        {% endif %}
                    </div>
                    <small class="text-muted d-block">
                        <i class="fas fa-map-marker-alt"></i> {{ delivery.delivery_address }}
                    </small>
                    <small class="text-muted">
                        <i class="fas fa-clock"></i> {{ delivery.scheduled_time_start|time:"H:i" }}
                        {% if delivery.delivery_type == 'pickup' %}
                        <span class="badge badge-info ml-2">Récupération</span>
                        {% endif %}
                    </small>
                </div>
                {% empty %}
                <div class="empty-state">
                    <i class="fas fa-check-circle text-success"></i>
                    <p>Toutes les livraisons sont assignées!</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Routes existantes -->
        <div class="routes-section">
            <h3 class="mb-3">
                <i class="fas fa-truck"></i> Routes actives
                <span class="badge badge-primary float-right">{{ routes.count }}</span>
            </h3>
            
            {% for route in routes %}
            <div class="route-box" data-route-id="{{ route.id }}">
                <div class="route-header">
                    <div class="driver-info">
                        <div class="driver-avatar">
                            {{ route.driver.first_name|first }}{{ route.driver.last_name|first }}
                        </div>
                        <div>
                            <strong>{{ route.driver.get_full_name }}</strong><br>
                            <small class="text-muted">{{ route.route_number }}</small>
                        </div>
                    </div>
                    <div>
                        <span class="badge badge-info">
                            <i class="fas fa-clock"></i> Départ: {{ route.start_time|time:"H:i" }}
                        </span>
                        {% if route.vehicle %}
                        <span class="badge badge-secondary ml-2">
                            <i class="fas fa-truck"></i> {{ route.vehicle }}
                        </span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="route-deliveries-area"
                     ondrop="drop(event, {{ route.id }})"
                     ondragover="allowDrop(event)"
                     ondragleave="dragLeave(event)">
                    {% for rd in route.route_deliveries.all %}
                    <div class="delivery-card priority-{{ rd.delivery.priority }}"
                         draggable="true"
                         ondragstart="drag(event)"
                         data-delivery-id="{{ rd.delivery.id }}">
                        <span class="badge badge-secondary">{{ rd.position|add:1 }}</span>
                        <strong>{{ rd.delivery.customer_name }}</strong>
                        <small class="text-muted d-block">
                            {{ rd.delivery.delivery_address }}
                        </small>
                    </div>
                    {% empty %}
                    <p class="text-muted text-center mb-0">
                        Glissez des livraisons ici
                    </p>
                    {% endfor %}
                </div>
                
                <div class="route-stats">
                    <div class="stat-item">
                        <div class="stat-value">{{ route.route_deliveries.count }}</div>
                        <div class="stat-label">Livraisons</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ route.total_distance|floatformat:1 }}</div>
                        <div class="stat-label">km total</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ route.estimated_duration }}</div>
                        <div class="stat-label">min estimé</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">
                            {% if route.is_optimized %}
                            <i class="fas fa-check text-success"></i>
                            {% else %}
                            <i class="fas fa-times text-danger"></i>
                            {% endif %}
                        </div>
                        <div class="stat-label">Optimisé</div>
                    </div>
                </div>
                
                <div class="text-center mt-3">
                    <button class="btn btn-sm btn-outline-primary" onclick="optimizeRoute({{ route.id }})">
                        <i class="fas fa-magic"></i> Optimiser
                    </button>
                    <button class="btn btn-sm btn-outline-info ml-2" onclick="printRoute({{ route.id }})">
                        <i class="fas fa-print"></i> Imprimer
                    </button>
                    <button class="btn btn-sm btn-outline-danger ml-2" onclick="deleteRoute({{ route.id }})">
                        <i class="fas fa-trash"></i> Supprimer
                    </button>
                </div>
            </div>
            {% empty %}
            <div class="empty-state">
                <i class="fas fa-route text-muted"></i>
                <p>Aucune route créée pour cette date</p>
                <button class="btn btn-primary" onclick="createNewRoute()">
                    <i class="fas fa-plus"></i> Créer une route
                </button>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Modal création de route -->
<div class="modal fade" id="createRouteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-route"></i> Nouvelle route</h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="createRouteForm">
                    <div class="form-group">
                        <label>Nom de la route</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>Livreur</label>
                        <select class="form-control" name="driver_id" required>
                            <option value="">Sélectionner...</option>
                            {% for driver in available_drivers %}
                            <option value="{{ driver.id }}">{{ driver.get_full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Heure de départ</label>
                        <input type="time" class="form-control" name="start_time" value="09:00" required>
                    </div>
                    <div class="form-group">
                        <label>Véhicule</label>
                        <input type="text" class="form-control" name="vehicle">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="submitCreateRoute()">
                    <i class="fas fa-plus"></i> Créer
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Drag and Drop
function allowDrop(ev) {
    ev.preventDefault();
    ev.currentTarget.classList.add('drag-over');
}

function dragLeave(ev) {
    ev.currentTarget.classList.remove('drag-over');
}

function drag(ev) {
    ev.dataTransfer.setData("deliveryId", ev.target.dataset.deliveryId);
    ev.target.classList.add('dragging');
}

function drop(ev, routeId) {
    ev.preventDefault();
    ev.currentTarget.classList.remove('drag-over');
    
    const deliveryId = ev.dataTransfer.getData("deliveryId");
    const deliveryElement = document.querySelector(`[data-delivery-id="${deliveryId}"]`);
    
    // Calculer les positions
    const positions = [];
    const existingDeliveries = ev.currentTarget.querySelectorAll('.delivery-card');
    existingDeliveries.forEach((el, idx) => {
        positions.push({
            delivery_id: el.dataset.deliveryId,
            position: idx
        });
    });
    
    // Ajouter la nouvelle si pas déjà présente
    if (!positions.find(p => p.delivery_id === deliveryId)) {
        positions.push({
            delivery_id: deliveryId,
            position: positions.length
        });
    }
    
    // Envoyer au serveur
    fetch('{% url "update_route_deliveries" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            route_id: routeId,
            positions: positions
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

function createNewRoute() {
    $('#createRouteModal').modal('show');
}

function submitCreateRoute() {
    const form = document.getElementById('createRouteForm');
    const formData = new FormData(form);
    
    const data = {
        name: formData.get('name'),
        driver_id: formData.get('driver_id'),
        date: '{{ selected_date|date:"Y-m-d" }}',
        start_time: formData.get('start_time'),
        vehicle: formData.get('vehicle')
    };
    
    fetch('{% url "create_route" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

function optimizeRoute(routeId) {
    if (confirm('Optimiser cette route?')) {
        fetch(`/delivery/routes/${routeId}/optimize/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    }
}

function deleteRoute(routeId) {
    if (confirm('Supprimer cette route?')) {
        // Implémenter la suppression
        alert('Fonction à implémenter');
    }
}

function printRoute(routeId) {
    window.open(`/delivery/route/${routeId}/print/`, '_blank');
}
</script>
{% endblock %}